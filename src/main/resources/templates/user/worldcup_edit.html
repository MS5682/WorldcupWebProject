<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
  <meta name="generator" content="Hugo 0.115.4">
  <title>이상형 월드컵 수정 및 선택지 추가</title>
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <link rel="canonical" href="https://getbootstrap.com/docs/5.3/examples/album/">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3">
  <link href="../assets/dist/css/bootstrap.min.css" rel="stylesheet">
  <link th:href="@{/css/styles.css}" rel="stylesheet">
</head>
<body>
<th:block th:replace="main/header :: header"></th:block>

<main>

  <div class="album py-5 bg-body-tertiary">
    <div class="container">

      <div class="top">
        <div><h2>이상형 월드컵 수정 및 선택지 추가</h2></div>
      </div>

      <form th:action="@{/update}" th:object="${result}" method="post">
        <input type="hidden" th:field="*{worldcupNum}">
        <table class="register">
          <tr>
            <th class="register-th">제목</th>
            <td class="register-td">
              <input class="border-none-input" placeholder="제목을 입력하세요" th:value="*{title}">
            </td>
          </tr>
          <tr>
            <th class="register-th">설명</th>
            <td class="register-td">
              <input class="border-none-input" placeholder="설명을 입력하세요" th:value="*{description}">
            </td>
          </tr>
          <tr>
            <th class="register-th">공개 여부</th>
            <td class="register-td">
              <label style="margin-left:5px;">
                <input type="radio" name="disclosure" value="1" th:checked="${result.disclosure == 1}">공개
              </label>
              <label>
                <input type="radio" name="disclosure" value="0" th:checked="${result.disclosure == 0}">비공개
              </label>
            </td>
          </tr>
          <tr>
            <th class="register-th">수정하기</th>
            <td class="register-td">
              <button type="submit" class="btn btn-sm btn-outline-secondary">수정하기</button>
            </td>
          </tr>
        </table>
      </form>

      <table class="register-choice">

        <tr>
          <th class="register-choice-th">선택지</th>
          <td class="register-choice-td">
            
            
            <table class="choice">
              <tr>
                <th class="choice-th col-1">순서</th>
                <th class="choice-th col-3">선택지 이름</th>
                <th class="choice-th col-2">이미지 미리보기</th>
                <th class="choice-th col-3">이미지 or 영상링크</th>
                <th class="choice-th col-1">삭제</th>
              </tr>




              <tr th:each="choice, choiceStat : ${result.choice}">
                  <td class="choice-td" th:text="${choiceStat.count}"></td>
                  <td class="choice-td">
                    <form>
                      <input name="name" class="form-control name" th:value="${choice.name}">
                      <button type="submit" class="btn btn-sm btn-outline-secondary">수정하기</button>
                    </form>
                  </td>
                  <td class="choice-td image-preview-td">
                    <img th:if="${choice.type == 1}" th:src="@{/worldcup/choice/display(fileName=${choice.getImageURL()})}" style="max-width: 200px; max-height: 200px;">
                    <img th:if="${choice.type == 0}" th:src="@{'https://img.youtube.com/vi/' + ${choice.imgName} + '/0.jpg'}" style="max-width: 200px; max-height: 200px;">
                  </td>
                  <td class="choice-td">
                    <form>
                      <input type="file" name="image" class="image-upload-field" th:if="${choice.type == 1}">
                      <input type="text" name="link" class="form-control link" th:if="${choice.type == 0}" th:value="${choice.path}">
                      <button type="submit" class="btn btn-sm btn-outline-secondary">수정하기</button>
                    </form>
                  </td>
                  <td class="choice-td">
                    <button class="btn btn-sm btn-outline-secondary">삭제하기</button>
                  </td>
              </tr>

              <tr>
                <td colspan="6" class="add-button text-end">
                  <button type="button" class="btn btn-sm btn-outline-secondary" id="addVideoBtn">영상추가하기</button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" id="addPhotoBtn">사진추가하기</button>
                </td>
              </tr>
            </table>

          </td>
        </tr>
        
      </table>
      <div class="text-end">
        <button type="button" class="btn btn-sm btn-outline-secondary ">돌아가기</button>
      </div>
    </div>
  </div>



<div class="modal fade" id="addImageModal" tabindex="-1" aria-labelledby="addImageModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addImageModalLabel">이미지 추가</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="imageForm">
          <input type="hidden" name="type" value="1">
          <input type="hidden" name="worldcupNum" th:value="${result.worldcupNum}">
          <label for="imageTitle" class="form-label">이름</label>
          <input type="text" class="form-control" id="imageTitle" name="name" required>
          
          <label for="imageFile" class="form-label">이미지 파일</label>
          <input type="file" class="form-control" id="imageFile" name="image" onchange="previewImage()" required>
          
          <div id="imagePreview" style="margin-top: 10px;"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
        <button type="button" class="btn btn-primary" onclick="submitImageForm()">추가하기</button>
      </div>
    </div>
  </div>
</div>




<div class="modal fade" id="addVideoModal" tabindex="-1" aria-labelledby="addVideoModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addVideoModalLabel">영상 추가</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="videoForm">
          <input type="hidden" name="type" value="0">
          <input type="hidden" name="worldcupNum" th:value="${result.worldcupNum}">
          <label for="videoTitle" class="form-label">제목</label>
          <input type="text" class="form-control" id="videoTitle" name="name" required>
          
          <label for="videoLink" class="form-label">영상 링크(유튜브만 지원)</label>
          <input type="text" class="form-control" id="videoLink" name="path" required>
          <div class="invalid-feedback"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
        <button type="button" class="btn btn-primary" onclick="submitVideoForm()">추가하기</button>
      </div>
    </div>
  </div>
</div>

</main>

<th:block th:replace="main/footer :: footer"></th:block>
<script>
  $("#addVideoBtn").click(function () {
    $('#addVideoModal').modal('show');
  });
  $("#addPhotoBtn").click(function () {
    $('#addImageModal').modal('show');
  });


  function submitImageForm() {
    var formData = new FormData(document.getElementById('imageForm'));

    $.ajax({
      url: '/worldcup/choice/upload',
      type: 'POST',
      data: formData,
      processData: false,
      contentType: false,
      success: function(response) {
        console.log(response);
        $('#addImageModal').modal('hide');
        location.reload();
      },
      error: function(xhr, status, error) {
        console.error(error);
        alert('이미지 추가에 실패했습니다.');
      }
    });

  }

  function submitVideoForm() {
      var videoLink = $('#videoLink').val();

      if (videoLink.startsWith("https://www.youtube.com/watch?v=")) {
          var videoId = extractYouTubeVideoId(videoLink);

          var formData = new FormData(document.getElementById('videoForm'));
          formData.append('imgName', videoId);

          $.ajax({
              url: '/worldcup/choice/upload',
              type: 'POST',
              data: formData,
              processData: false,
              contentType: false,
              success: function (response) {
                  console.log(response);
                  $('#addVideoModal').modal('hide');
                  location.reload();
              },
              error: function (xhr, status, error) {
                  console.error(error);
                  alert('영상 링크 추가에 실패했습니다.');
              }
          });
      } else {
          // 유효하지 않은 경우 알림 표시
          alert('유효한 YouTube 영상 링크를 입력하세요.');
      }
  }

  // YouTube 링크에서 비디오 ID를 추출하는 함수
  function extractYouTubeVideoId(url) {
      var videoId = null;
      var match = url.match(/[?&]v=([^&]+)/);
      if (match) {
          videoId = match[1];
      }
      return videoId;
  }




  function previewImage() {
    var input = document.getElementById('imageFile');
    var preview = document.getElementById('imagePreview');
    
    while (preview.firstChild) {
      preview.removeChild(preview.firstChild);
    }

    if (input.files && input.files[0]) {
      var reader = new FileReader();

      reader.onload = function (e) {
        var img = document.createElement('img');
        img.src = e.target.result;
        img.style.maxWidth = '100%';
        img.style.maxHeight = '150px';

        preview.appendChild(img);
      };

      reader.readAsDataURL(input.files[0]);
    }
  }
</script>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script>
  $(document).ready(function () {
     $('#videoLink').on('input', function() {
        var inputValue = $(this).val();
        var youtubePrefix = "https://www.youtube.com/watch?v=";

        if (!inputValue.startsWith(youtubePrefix)) {
            $(this).addClass('is-invalid');
            $(this).removeClass('is-valid');
            $(this).siblings('.invalid-feedback').text('"https://www.youtube.com/watch?v=" 로 시작해야 합니다.');
        } else {
            $(this).removeClass('is-invalid');
            $(this).addClass('is-valid');
            $(this).siblings('.invalid-feedback').text('');
        }
    });

    $('.image-upload-field').change(function () {
      
      var input = $(this);
      var previewTd = input.closest('tr').find('.image-preview-td');
      previewTd.empty();

      if (input[0].files && input[0].files[0]) {
        var reader = new FileReader();

        reader.onload = function (e) {
          var img = $('<img>').attr('src', e.target.result);
          img.css({ 'max-width': '100%', 'max-height': '150px' });
          previewTd.append(img);
        };

        reader.readAsDataURL(input[0].files[0]);
      }
    });
  });
</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    </body>
</html>
